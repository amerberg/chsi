<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style>

.counties {
  fill: none;
}

.states {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
}

.missing-data {fill: linen;}
.outlier {fill: red;}
.q0 { fill:rgb(247,252,253); }
.q1 { fill:rgb(229,245,249); }
.q2 { fill:rgb(204,236,230); }
.q3 { fill:rgb(153,216,201); }
.q4 { fill:rgb(102,194,164); }
.q5 { fill:rgb(65,174,118); }
.q6 { fill:rgb(35,139,69); }
.q7 { fill:rgb(0,109,44); }
.q8 { fill:rgb(0,68,27); }

.county-info {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

</style>
<title>CHSI data</title>
</head>
<body>
<script src="library/d3.v3.min.js"></script>
<script src="library/queue.v1.min.js"></script>
<script src="library/topojson.v1.min.js"></script>
<script src="library/tip.js"></script>
<script src="library/jquery-3.0.0.min.js"   integrity="sha256-JmvOoLtYsmqlsWxa7mDSLMwa6dZ9rrIdtrrVYRnDRH0="   crossorigin="anonymous"></script>
<script src="library/chosen.jquery.min.js"></script>
<link rel="stylesheet" href="library/chosen.min.css">
<form>
  <select id='column'>
  </select>
  <label>Outlier threshold: </label> <input type='text' id='threshold' placeholder='standard deviations'>
</form>
<script>

d3.select('form')
  .on('change', colorMap);

var width = 960,
    height = 600;

var valueById = d3.map();
var maxById = d3.map();

function quantileClass(quantile) {
  return "q" + quantile;
}

function mean(numbers) {
  total = 0;
  for(i=0; i<numbers.length; ++i){
    total += numbers[i];
  }
  return total/numbers.length
}

function stdev(numbers) {
  avg = mean(numbers);
  return Math.sqrt(mean(numbers.map(function(c){return Math.pow(c-avg, 2);})));
}


function quantize(column, sds){
  var values = valueById.values().map(function(d){return +d[column];});
  values = values.filter(function(element){return !isNaN(element)})
  
  if(!isNaN(sds) && sds > 0) {
    var sd = stdev(values);
    var avg = mean(values);
    values = values.filter(function(element){return element < avg+sds*sd && element > avg-sds*sd});
  }
  
  var maximum = Math.max.apply(null, values);
  var minimum = Math.min.apply(null, values);

  return d3.scale.quantize()
    .domain([minimum, maximum])
    .range(d3.range(9).map(quantileClass));
}

var projection = d3.geo.albersUsa()
    .scale(1280)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);
    
function getTip(column){
  return d3.tip()
    .attr('class', 'county-info')
    .offset([-10, 0])
    .html(function(d) {
      v = valueById.get(d.id);
      return v.CHSI_County_Name + ", " + v.CHSI_State_Abbr + "<br />" + Math.round(+v[column] * 100) / 100;
    });
}

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);
    
queue()
    .defer(d3.json, "us.json")
    .defer(d3.csv, "processed.csv", function(d) {valueById.set(d['county_id'], d); })
    .await(drawMap);

function countyClass(d, column, quantize) {
  try{
    value = +valueById.get(d.id)[column];
    if(isNaN(value)) {
      return "missing-data";
    }
    else if(value < quantize.domain()[0] || value > quantize.domain()[1]){
      return "outlier";
    }
    else {
      return quantize(value);
    }
  }
  catch(err){
    return ""
  }
}

function drawMap(error, us) {
  if (error) throw error;

  svg.append("g")
      .attr("class", "counties")
    .selectAll("path")
      .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
      .classed({"county" : true})
      .attr("d", path);

  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("d", path);
      
  svg.append("g")
    .attr("class", "key")
    .selectAll("rect")
    .data([0, 1, 2, 3, 4, 5, 6, 7, 8])
    .enter().append("rect")
    .attr("class", quantileClass)
    .classed({"key-rect" : true})
    .attr("x", 900)
    .attr("y", function(d){return 250 + 20 * d;})
    .attr("width", 20)
    .attr("height", 20);
    
  svg.append("text")
    .attr("class", "key-min")
    .attr("x", 900)
    .attr("y", 245);

  svg.append("text")
    .attr("class", "key-max")
    .attr("x", 900)
    .attr("y", 445);
    
    
  var column = d3.select('#column')
  var county = valueById.get(1001);
  for (var key in county) {
    if (county.hasOwnProperty(key) && key != 'county_id' &&
        (county[key] == "NA" || !isNaN(+county[key]))) {
      column.append("option")
        .attr('value', key)
        .text(key.split('_').join(" "));
    }
  }
  
  $('#column').chosen()
    .change(colorMap);
    
  colorMap();
}

function colorMap() {
  var column = document.getElementById('column').value
  var sds = +document.getElementById('threshold').value
  var q = quantize(column, sds);
  var tip = getTip(column);
  svg.call(tip);
  
  svg.selectAll("path.county")
  .attr("class", function(d) {return countyClass(d, column, q)})
  .classed({"county" : true})
  .on('mouseover', tip.show)
  .on('mouseout', tip.hide);
  
  svg.select("text.key-min").text(Math.round(q.domain()[0]));
  svg.select("text.key-max").text(Math.round(q.domain()[1]));
}

d3.select(self.frameElement).style("height", height + "px");

</script>
</body>
</html>